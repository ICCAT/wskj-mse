---
title: "Operating model (OM) conditioning report for `r ifelse(nchar(OM@Name) > 0, OM@Name, substitute(OM))`"
subtitle: Output from SAMtool Rapid Conditioning Model (RCM)
date: "`r Sys.Date()`"
---
<style type="text/css">
h1 { /* Header 1 */
  font-size: 24px;
}
</style>

```{r setup, include = FALSE, echo = FALSE}
  knitr::opts_chunk$set(collapse = TRUE, echo = FALSE, message = FALSE,
  fig.width = 6, fig.height = 4.5, out.width = "650px", comment = "#>")
```

# Summary {.tabset}

## Updated historical OM parameters

```{r, fig.cap = "Histogram of R0 (unfished recruitment)."}
if(!is.null(OM@cpars$R0)) hist(OM@cpars$R0, main = "", xlab = expression(R[0]))
```

```{r, fig.cap = "Histogram of historical depletion."}
if(!is.null(OM@cpars$D)) hist(OM@cpars$D, main = "", xlab = "Depletion")
```

```{r, fig.cap = "Historical recruitment deviations among simulations."}
Perr <- OM@cpars$Perr_y[, (max_age+1):(max_age+nyears), drop = FALSE]
matplot(Year, t(Perr), type = "l", col = "black", xlab = "Year", ylab = "Recruitment deviations",
        ylim = c(0, 1.1 * max(Perr)))
abline(h = 0, col = "grey")
```


```{r, fig.cap = "Future recruitment deviations (up to 5 simulations)."}
Perr_future <- OM@cpars$Perr_y[, (max_age+nyears+1):(max_age+nyears+proyears)]
matplot(Year, t(Perr), type = "l", col = "black", xlab = "Year", ylab = "Recruitment deviations",
        xlim = c(min(Year), max(Year) + proyears), ylim = c(0, 1.1 * max(c(Perr, Perr_future))))
matlines(max(Year) + 1:proyears, t(Perr_future[1:min(5, nrow(OM@cpars$Perr_y)), ]), type = "l")
abline(h = 0, col = "grey")
abline(v = max(Year), lty = 3)
```


```{r, fig.cap = "Annual mean and median of future recruitment deviations."}
matplot(Year, t(Perr), type = "n", xlab = "Year", ylab = "Recruitment deviations",
        xlim = c(min(Year), max(Year) + proyears), ylim = c(0, 1.1 * max(c(Perr, Perr_future))))
abline(h = c(0, 1), col = "grey")
abline(v = max(Year), lty = 3)
matlines(Year, t(Perr), type = "l", col = "black")
lines(max(Year) + 1:proyears, apply(Perr_future, 2, mean), col = "red")
lines(max(Year) + 1:proyears, apply(Perr_future, 2, median), lty = 2)
legend("topleft", c("Mean", "Median"), col = c("red", "black"), lty = c(1, 2))
```

```{r, fig.cap = "Histogram of recruitment autocorrelation."}
if(!is.null(OM@cpars$AC)) hist(OM@cpars$AC, main = "", xlab = "Recruitment Autocorrelation")
```

```{r, fig.cap = "Apical F from RCM model. These values may be subsequently re-scaled in the operating model in order to match the specified depletion"}
matplot(Year, t(OM@cpars$Find), type = "l", col = "black", xlab = "Year", ylab = "Apical F")
abline(h = 0, col = "grey")
```

```{r, fig.cap = "Operating model selectivity among simulations."}
vul <- sapply(report_list, getElement, "vul_len")
if(nsel_block == 1 && all(!is.na(vul))) {
  matplot(RCMdata@Misc$lbinmid, vul, type = "l", col = "black",
          xlab = "Length", ylab = "Selectivity (last historical year)", ylim = c(0, 1.1))
} else {
  if(nsim == 1) V_plot <- matrix(OM@cpars$V[, , nyears], 1, byrow = TRUE) else V_plot <- OM@cpars$V[, , nyears]
  matplot(age, t(V_plot), type = "l", col = "black",
          xlab = "Age", ylab = "Selectivity (last historical year)", ylim = c(0, 1.1))
}
abline(h = 0, col = "grey")
```

## Correlations

```{r, fig.cap="Correlation between unfished recruitment and depletion in operating model."}
plot(OM@cpars$R0, OM@cpars$D, xlab = expression(R[0]), ylab = "Depletion", pch = 21, bg = "grey")
```






## RCM output {.tabset}

###  PS_West 

```{r, fig.cap = "Selectivity of PS_West."}
bl <- unique(RCMdata@sel_block[, 1])
vul_bb <- list()
bl_col <- gplots::rich.colors(length(bl))
Year_legend <- character(length(bl))
for(bb in 1:length(bl)) {
  vul_bb[[bb]] <- sapply(report_list, function(x) x$vul_len[, bl[bb]])
  Year_legend[bb] <- Year[RCMdata@sel_block[, 1] == bl[bb]] %>% range() %>% paste(collapse = "-")
}
test <- vapply(vul_bb, function(x) all(!is.na(x)), logical(1))
if(all(test)) {
  matplot(RCMdata@Misc$lbinmid, RCMdata@Misc$lbinmid, type = "n", xlab = "Length", ylim = c(0, 1), ylab = "Selectivity of Fleet 1")
  abline(h = 0, col = "grey")
  for(bb in 1:length(bl)) {
    matlines(RCMdata@Misc$lbinmid, vul_bb[[bb]], type = "l", col = bl_col[bb], lty = scenario$lty, lwd = scenario$lwd)
  }
  if(length(bl) > 1) legend("topright", Year_legend, col = bl_col, lwd = 1)
}
```


```{r, fig.cap = "Corresponding age-based selectivity of PS_West."}
matplot(age, age, type = "n", xlab = "Age", ylim = c(0, 1), ylab = "Selectivity of Fleet 1")
abline(h = 0, col = "grey")

for(bb in 1:length(bl)) {
  vul_bb_age <- do.call(rbind, lapply(report_list, function(x) x$vul[RCMdata@sel_block[, 1] == bl[bb], , 1])) %>% t()
  matlines(age, vul_bb_age, type = "l", col = bl_col[bb], lty = scenario$lty, lwd = scenario$lwd)
}
if(length(bl) > 1) legend("topleft", Year_legend, col = bl_col, lwd = 1)
```


```{r, fig.cap = "Fishing Mortality of PS_West."}
FM <- sapply(report_list, function(x) x$F[, 1])
matplot(Year, FM, type = "l", col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, ylim = c(0, 1.1 * max(FM, na.rm = TRUE)), xlab = "Year", ylab = "Fishing Mortality of PS_West")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) catch from PS_West."}
if(any(RCMdata@Chist[, 1] > 0)) {
  Cpred <- sapply(report_list, function(x) x$Cpred[, 1])
  Chist <- RCMdata@Chist[, 1]
  ylim <- c(0.9, 1.1) * range(c(Cpred, Chist), na.rm = TRUE)
  plot(Year, Chist, type = "o", xlab = "Year", ylab = "Catch of PS_West", ylim = ylim)
  matlines(Year, Cpred, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
} else {
  Cpred <- sapply(report_list, function(x) x$Cpred[, 1]/mean(x$Cpred[, 1]))
  matplot(Year, Cpred, col = scenario$col, type = "l", lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Predicted relative catch of PS_West")
}
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) mean ages from PS_West."}
MApred <- sapply(report_list, function(x) x$CAApred[, , 1] %*% age/x$CN[, 1])
MAobs <- (RCMdata@CAA[, , 1] %*% age)/rowSums(RCMdata@CAA[, , 1], na.rm = TRUE)
ylim <- c(0.9, 1.1) * range(c(MApred, MAobs), na.rm = TRUE)
matplot(Year, MApred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean age", ylim = ylim)
if(any(RCMdata@CAA[, , 1] > 0, na.rm = TRUE)) {
  lines(Year, MAobs, col = "black", typ = "o")
}
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) mean lengths from PS_West."}
MLpred <- sapply(report_list, function(x) x$MLpred[, 1])
if(any(RCMdata@CAL[, , 1] > 0, na.rm = TRUE)) {
  MLobs <- (RCMdata@CAL[, , 1] %*% RCMdata@Misc$lbinmid)/rowSums(RCMdata@CAL[, , 1], na.rm = TRUE)
} else if(RCMdata@MS_type == "length" && any(RCMdata@MS[, 1] > 0, na.rm = TRUE)) MLobs <- RCMdata@MS[, 1] else MLobs <- NA
if(!all(is.na(MLpred))) {
  ylim <- c(0.9, 1.1) * range(c(MLpred, MLobs), na.rm = TRUE)
  matplot(Year, MLpred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean length", ylim = ylim)
  if(!all(is.na(MLobs))) lines(Year, MLobs, col = "black", typ = "o")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) mean weights from PS_West."}
if(RCMdata@MS_type == "weight" && any(RCMdata@MS[, 1] > 0, na.rm = TRUE)) {
  MWobs <- RCMdata@MS[, 1]
} else MWobs <- NA
if(!all(is.na(MWobs))) {
  MWpred <- sapply(report_list, function(x) x$MWpred[, 1])
  ylim <- c(0.9, 1.1) * range(c(MWpred, MWobs), na.rm = TRUE)
  matplot(Year, MWpred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean weight", ylim = ylim)
  lines(Year, MWobs, col = "black", typ = "o")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) age composition from PS_West."}
if(any(RCMdata@CAA[, , 1] > 0, na.rm = TRUE)) {
if(nsim == 1) CAA_plot <- array(x@CAA[, , , 1], c(1, nyears, max_age + 1)) else CAA_plot <- x@CAA[, , , 1]
plot_composition_RCM(Year, CAA_plot, RCMdata@CAA[, , 1], ages = age, dat_col = scenario$col)
}
```

```{r, fig.cap = "Predicted age composition from fleet 1."}
if(any(RCMdata@CAA[, , 1] > 0, na.rm = TRUE)) {
plot_composition_RCM(Year, CAA_plot, ages = age, dat_col = scenario$col)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) length composition from PS_West."}
if(any(RCMdata@CAL[, , 1] > 0, na.rm = TRUE)) {
if(nsim == 1) CAL_plot <- array(x@CAL[, , , 1], c(1, nyears, RCMdata@Misc$nlbin)) else CAL_plot <- x@CAL[, , , 1]
plot_composition_RCM(Year, fit = CAL_plot, dat = RCMdata@CAL[, , 1], CAL_bins = length_bin, dat_col = scenario$col)
}
```


```{r, fig.cap = "Predicted length composition from PS_West."}
if(any(RCMdata@CAL[, , 1] > 0, na.rm = TRUE)) {
plot_composition_RCM(Year, fit = CAL_plot, CAL_bins = RCMdata@Misc$lbinmid, dat_col = scenario$col)
}
```

###  BB_West 

```{r, fig.cap = "Selectivity of BB_West."}
bl <- unique(RCMdata@sel_block[, 2])
vul_bb <- list()
bl_col <- gplots::rich.colors(length(bl))
Year_legend <- character(length(bl))
for(bb in 1:length(bl)) {
  vul_bb[[bb]] <- sapply(report_list, function(x) x$vul_len[, bl[bb]])
  Year_legend[bb] <- Year[RCMdata@sel_block[, 2] == bl[bb]] %>% range() %>% paste(collapse = "-")
}
test <- vapply(vul_bb, function(x) all(!is.na(x)), logical(1))
if(all(test)) {
  matplot(RCMdata@Misc$lbinmid, RCMdata@Misc$lbinmid, type = "n", xlab = "Length", ylim = c(0, 1), ylab = "Selectivity of Fleet 2")
  abline(h = 0, col = "grey")
  for(bb in 1:length(bl)) {
    matlines(RCMdata@Misc$lbinmid, vul_bb[[bb]], type = "l", col = bl_col[bb], lty = scenario$lty, lwd = scenario$lwd)
  }
  if(length(bl) > 1) legend("topright", Year_legend, col = bl_col, lwd = 1)
}
```


```{r, fig.cap = "Corresponding age-based selectivity of BB_West."}
matplot(age, age, type = "n", xlab = "Age", ylim = c(0, 1), ylab = "Selectivity of Fleet 2")
abline(h = 0, col = "grey")

for(bb in 1:length(bl)) {
  vul_bb_age <- do.call(rbind, lapply(report_list, function(x) x$vul[RCMdata@sel_block[, 2] == bl[bb], , 2])) %>% t()
  matlines(age, vul_bb_age, type = "l", col = bl_col[bb], lty = scenario$lty, lwd = scenario$lwd)
}
if(length(bl) > 1) legend("topleft", Year_legend, col = bl_col, lwd = 1)
```


```{r, fig.cap = "Fishing Mortality of BB_West."}
FM <- sapply(report_list, function(x) x$F[, 2])
matplot(Year, FM, type = "l", col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, ylim = c(0, 1.1 * max(FM, na.rm = TRUE)), xlab = "Year", ylab = "Fishing Mortality of BB_West")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) catch from BB_West."}
if(any(RCMdata@Chist[, 2] > 0)) {
  Cpred <- sapply(report_list, function(x) x$Cpred[, 2])
  Chist <- RCMdata@Chist[, 2]
  ylim <- c(0.9, 1.1) * range(c(Cpred, Chist), na.rm = TRUE)
  plot(Year, Chist, type = "o", xlab = "Year", ylab = "Catch of BB_West", ylim = ylim)
  matlines(Year, Cpred, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
} else {
  Cpred <- sapply(report_list, function(x) x$Cpred[, 2]/mean(x$Cpred[, 2]))
  matplot(Year, Cpred, col = scenario$col, type = "l", lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Predicted relative catch of BB_West")
}
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) mean ages from BB_West."}
MApred <- sapply(report_list, function(x) x$CAApred[, , 2] %*% age/x$CN[, 2])
MAobs <- (RCMdata@CAA[, , 2] %*% age)/rowSums(RCMdata@CAA[, , 2], na.rm = TRUE)
ylim <- c(0.9, 1.1) * range(c(MApred, MAobs), na.rm = TRUE)
matplot(Year, MApred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean age", ylim = ylim)
if(any(RCMdata@CAA[, , 2] > 0, na.rm = TRUE)) {
  lines(Year, MAobs, col = "black", typ = "o")
}
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) mean lengths from BB_West."}
MLpred <- sapply(report_list, function(x) x$MLpred[, 2])
if(any(RCMdata@CAL[, , 2] > 0, na.rm = TRUE)) {
  MLobs <- (RCMdata@CAL[, , 2] %*% RCMdata@Misc$lbinmid)/rowSums(RCMdata@CAL[, , 2], na.rm = TRUE)
} else if(RCMdata@MS_type == "length" && any(RCMdata@MS[, 2] > 0, na.rm = TRUE)) MLobs <- RCMdata@MS[, 2] else MLobs <- NA
if(!all(is.na(MLpred))) {
  ylim <- c(0.9, 1.1) * range(c(MLpred, MLobs), na.rm = TRUE)
  matplot(Year, MLpred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean length", ylim = ylim)
  if(!all(is.na(MLobs))) lines(Year, MLobs, col = "black", typ = "o")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) mean weights from BB_West."}
if(RCMdata@MS_type == "weight" && any(RCMdata@MS[, 2] > 0, na.rm = TRUE)) {
  MWobs <- RCMdata@MS[, 2]
} else MWobs <- NA
if(!all(is.na(MWobs))) {
  MWpred <- sapply(report_list, function(x) x$MWpred[, 2])
  ylim <- c(0.9, 1.1) * range(c(MWpred, MWobs), na.rm = TRUE)
  matplot(Year, MWpred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean weight", ylim = ylim)
  lines(Year, MWobs, col = "black", typ = "o")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) age composition from BB_West."}
if(any(RCMdata@CAA[, , 2] > 0, na.rm = TRUE)) {
if(nsim == 1) CAA_plot <- array(x@CAA[, , , 2], c(1, nyears, max_age + 1)) else CAA_plot <- x@CAA[, , , 2]
plot_composition_RCM(Year, CAA_plot, RCMdata@CAA[, , 2], ages = age, dat_col = scenario$col)
}
```

```{r, fig.cap = "Predicted age composition from fleet 2."}
if(any(RCMdata@CAA[, , 2] > 0, na.rm = TRUE)) {
plot_composition_RCM(Year, CAA_plot, ages = age, dat_col = scenario$col)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) length composition from BB_West."}
if(any(RCMdata@CAL[, , 2] > 0, na.rm = TRUE)) {
if(nsim == 1) CAL_plot <- array(x@CAL[, , , 2], c(1, nyears, RCMdata@Misc$nlbin)) else CAL_plot <- x@CAL[, , , 2]
plot_composition_RCM(Year, fit = CAL_plot, dat = RCMdata@CAL[, , 2], CAL_bins = length_bin, dat_col = scenario$col)
}
```


```{r, fig.cap = "Predicted length composition from BB_West."}
if(any(RCMdata@CAL[, , 2] > 0, na.rm = TRUE)) {
plot_composition_RCM(Year, fit = CAL_plot, CAL_bins = RCMdata@Misc$lbinmid, dat_col = scenario$col)
}
```

###  LL_USMX 

```{r, fig.cap = "Selectivity of LL_USMX."}
bl <- unique(RCMdata@sel_block[, 3])
vul_bb <- list()
bl_col <- gplots::rich.colors(length(bl))
Year_legend <- character(length(bl))
for(bb in 1:length(bl)) {
  vul_bb[[bb]] <- sapply(report_list, function(x) x$vul_len[, bl[bb]])
  Year_legend[bb] <- Year[RCMdata@sel_block[, 3] == bl[bb]] %>% range() %>% paste(collapse = "-")
}
test <- vapply(vul_bb, function(x) all(!is.na(x)), logical(1))
if(all(test)) {
  matplot(RCMdata@Misc$lbinmid, RCMdata@Misc$lbinmid, type = "n", xlab = "Length", ylim = c(0, 1), ylab = "Selectivity of Fleet 3")
  abline(h = 0, col = "grey")
  for(bb in 1:length(bl)) {
    matlines(RCMdata@Misc$lbinmid, vul_bb[[bb]], type = "l", col = bl_col[bb], lty = scenario$lty, lwd = scenario$lwd)
  }
  if(length(bl) > 1) legend("topright", Year_legend, col = bl_col, lwd = 1)
}
```


```{r, fig.cap = "Corresponding age-based selectivity of LL_USMX."}
matplot(age, age, type = "n", xlab = "Age", ylim = c(0, 1), ylab = "Selectivity of Fleet 3")
abline(h = 0, col = "grey")

for(bb in 1:length(bl)) {
  vul_bb_age <- do.call(rbind, lapply(report_list, function(x) x$vul[RCMdata@sel_block[, 3] == bl[bb], , 3])) %>% t()
  matlines(age, vul_bb_age, type = "l", col = bl_col[bb], lty = scenario$lty, lwd = scenario$lwd)
}
if(length(bl) > 1) legend("topleft", Year_legend, col = bl_col, lwd = 1)
```


```{r, fig.cap = "Fishing Mortality of LL_USMX."}
FM <- sapply(report_list, function(x) x$F[, 3])
matplot(Year, FM, type = "l", col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, ylim = c(0, 1.1 * max(FM, na.rm = TRUE)), xlab = "Year", ylab = "Fishing Mortality of LL_USMX")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) catch from LL_USMX."}
if(any(RCMdata@Chist[, 3] > 0)) {
  Cpred <- sapply(report_list, function(x) x$Cpred[, 3])
  Chist <- RCMdata@Chist[, 3]
  ylim <- c(0.9, 1.1) * range(c(Cpred, Chist), na.rm = TRUE)
  plot(Year, Chist, type = "o", xlab = "Year", ylab = "Catch of LL_USMX", ylim = ylim)
  matlines(Year, Cpred, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
} else {
  Cpred <- sapply(report_list, function(x) x$Cpred[, 3]/mean(x$Cpred[, 3]))
  matplot(Year, Cpred, col = scenario$col, type = "l", lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Predicted relative catch of LL_USMX")
}
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) mean ages from LL_USMX."}
MApred <- sapply(report_list, function(x) x$CAApred[, , 3] %*% age/x$CN[, 3])
MAobs <- (RCMdata@CAA[, , 3] %*% age)/rowSums(RCMdata@CAA[, , 3], na.rm = TRUE)
ylim <- c(0.9, 1.1) * range(c(MApred, MAobs), na.rm = TRUE)
matplot(Year, MApred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean age", ylim = ylim)
if(any(RCMdata@CAA[, , 3] > 0, na.rm = TRUE)) {
  lines(Year, MAobs, col = "black", typ = "o")
}
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) mean lengths from LL_USMX."}
MLpred <- sapply(report_list, function(x) x$MLpred[, 3])
if(any(RCMdata@CAL[, , 3] > 0, na.rm = TRUE)) {
  MLobs <- (RCMdata@CAL[, , 3] %*% RCMdata@Misc$lbinmid)/rowSums(RCMdata@CAL[, , 3], na.rm = TRUE)
} else if(RCMdata@MS_type == "length" && any(RCMdata@MS[, 3] > 0, na.rm = TRUE)) MLobs <- RCMdata@MS[, 3] else MLobs <- NA
if(!all(is.na(MLpred))) {
  ylim <- c(0.9, 1.1) * range(c(MLpred, MLobs), na.rm = TRUE)
  matplot(Year, MLpred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean length", ylim = ylim)
  if(!all(is.na(MLobs))) lines(Year, MLobs, col = "black", typ = "o")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) mean weights from LL_USMX."}
if(RCMdata@MS_type == "weight" && any(RCMdata@MS[, 3] > 0, na.rm = TRUE)) {
  MWobs <- RCMdata@MS[, 3]
} else MWobs <- NA
if(!all(is.na(MWobs))) {
  MWpred <- sapply(report_list, function(x) x$MWpred[, 3])
  ylim <- c(0.9, 1.1) * range(c(MWpred, MWobs), na.rm = TRUE)
  matplot(Year, MWpred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean weight", ylim = ylim)
  lines(Year, MWobs, col = "black", typ = "o")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) age composition from LL_USMX."}
if(any(RCMdata@CAA[, , 3] > 0, na.rm = TRUE)) {
if(nsim == 1) CAA_plot <- array(x@CAA[, , , 3], c(1, nyears, max_age + 1)) else CAA_plot <- x@CAA[, , , 3]
plot_composition_RCM(Year, CAA_plot, RCMdata@CAA[, , 3], ages = age, dat_col = scenario$col)
}
```

```{r, fig.cap = "Predicted age composition from fleet 3."}
if(any(RCMdata@CAA[, , 3] > 0, na.rm = TRUE)) {
plot_composition_RCM(Year, CAA_plot, ages = age, dat_col = scenario$col)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) length composition from LL_USMX."}
if(any(RCMdata@CAL[, , 3] > 0, na.rm = TRUE)) {
if(nsim == 1) CAL_plot <- array(x@CAL[, , , 3], c(1, nyears, RCMdata@Misc$nlbin)) else CAL_plot <- x@CAL[, , , 3]
plot_composition_RCM(Year, fit = CAL_plot, dat = RCMdata@CAL[, , 3], CAL_bins = length_bin, dat_col = scenario$col)
}
```


```{r, fig.cap = "Predicted length composition from LL_USMX."}
if(any(RCMdata@CAL[, , 3] > 0, na.rm = TRUE)) {
plot_composition_RCM(Year, fit = CAL_plot, CAL_bins = RCMdata@Misc$lbinmid, dat_col = scenario$col)
}
```

###  LL_Others 

```{r, fig.cap = "Selectivity of LL_Others."}
bl <- unique(RCMdata@sel_block[, 4])
vul_bb <- list()
bl_col <- gplots::rich.colors(length(bl))
Year_legend <- character(length(bl))
for(bb in 1:length(bl)) {
  vul_bb[[bb]] <- sapply(report_list, function(x) x$vul_len[, bl[bb]])
  Year_legend[bb] <- Year[RCMdata@sel_block[, 4] == bl[bb]] %>% range() %>% paste(collapse = "-")
}
test <- vapply(vul_bb, function(x) all(!is.na(x)), logical(1))
if(all(test)) {
  matplot(RCMdata@Misc$lbinmid, RCMdata@Misc$lbinmid, type = "n", xlab = "Length", ylim = c(0, 1), ylab = "Selectivity of Fleet 4")
  abline(h = 0, col = "grey")
  for(bb in 1:length(bl)) {
    matlines(RCMdata@Misc$lbinmid, vul_bb[[bb]], type = "l", col = bl_col[bb], lty = scenario$lty, lwd = scenario$lwd)
  }
  if(length(bl) > 1) legend("topright", Year_legend, col = bl_col, lwd = 1)
}
```


```{r, fig.cap = "Corresponding age-based selectivity of LL_Others."}
matplot(age, age, type = "n", xlab = "Age", ylim = c(0, 1), ylab = "Selectivity of Fleet 4")
abline(h = 0, col = "grey")

for(bb in 1:length(bl)) {
  vul_bb_age <- do.call(rbind, lapply(report_list, function(x) x$vul[RCMdata@sel_block[, 4] == bl[bb], , 4])) %>% t()
  matlines(age, vul_bb_age, type = "l", col = bl_col[bb], lty = scenario$lty, lwd = scenario$lwd)
}
if(length(bl) > 1) legend("topleft", Year_legend, col = bl_col, lwd = 1)
```


```{r, fig.cap = "Fishing Mortality of LL_Others."}
FM <- sapply(report_list, function(x) x$F[, 4])
matplot(Year, FM, type = "l", col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, ylim = c(0, 1.1 * max(FM, na.rm = TRUE)), xlab = "Year", ylab = "Fishing Mortality of LL_Others")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) catch from LL_Others."}
if(any(RCMdata@Chist[, 4] > 0)) {
  Cpred <- sapply(report_list, function(x) x$Cpred[, 4])
  Chist <- RCMdata@Chist[, 4]
  ylim <- c(0.9, 1.1) * range(c(Cpred, Chist), na.rm = TRUE)
  plot(Year, Chist, type = "o", xlab = "Year", ylab = "Catch of LL_Others", ylim = ylim)
  matlines(Year, Cpred, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
} else {
  Cpred <- sapply(report_list, function(x) x$Cpred[, 4]/mean(x$Cpred[, 4]))
  matplot(Year, Cpred, col = scenario$col, type = "l", lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Predicted relative catch of LL_Others")
}
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) mean ages from LL_Others."}
MApred <- sapply(report_list, function(x) x$CAApred[, , 4] %*% age/x$CN[, 4])
MAobs <- (RCMdata@CAA[, , 4] %*% age)/rowSums(RCMdata@CAA[, , 4], na.rm = TRUE)
ylim <- c(0.9, 1.1) * range(c(MApred, MAobs), na.rm = TRUE)
matplot(Year, MApred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean age", ylim = ylim)
if(any(RCMdata@CAA[, , 4] > 0, na.rm = TRUE)) {
  lines(Year, MAobs, col = "black", typ = "o")
}
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) mean lengths from LL_Others."}
MLpred <- sapply(report_list, function(x) x$MLpred[, 4])
if(any(RCMdata@CAL[, , 4] > 0, na.rm = TRUE)) {
  MLobs <- (RCMdata@CAL[, , 4] %*% RCMdata@Misc$lbinmid)/rowSums(RCMdata@CAL[, , 4], na.rm = TRUE)
} else if(RCMdata@MS_type == "length" && any(RCMdata@MS[, 4] > 0, na.rm = TRUE)) MLobs <- RCMdata@MS[, 4] else MLobs <- NA
if(!all(is.na(MLpred))) {
  ylim <- c(0.9, 1.1) * range(c(MLpred, MLobs), na.rm = TRUE)
  matplot(Year, MLpred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean length", ylim = ylim)
  if(!all(is.na(MLobs))) lines(Year, MLobs, col = "black", typ = "o")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) mean weights from LL_Others."}
if(RCMdata@MS_type == "weight" && any(RCMdata@MS[, 4] > 0, na.rm = TRUE)) {
  MWobs <- RCMdata@MS[, 4]
} else MWobs <- NA
if(!all(is.na(MWobs))) {
  MWpred <- sapply(report_list, function(x) x$MWpred[, 4])
  ylim <- c(0.9, 1.1) * range(c(MWpred, MWobs), na.rm = TRUE)
  matplot(Year, MWpred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean weight", ylim = ylim)
  lines(Year, MWobs, col = "black", typ = "o")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) age composition from LL_Others."}
if(any(RCMdata@CAA[, , 4] > 0, na.rm = TRUE)) {
if(nsim == 1) CAA_plot <- array(x@CAA[, , , 4], c(1, nyears, max_age + 1)) else CAA_plot <- x@CAA[, , , 4]
plot_composition_RCM(Year, CAA_plot, RCMdata@CAA[, , 4], ages = age, dat_col = scenario$col)
}
```

```{r, fig.cap = "Predicted age composition from fleet 4."}
if(any(RCMdata@CAA[, , 4] > 0, na.rm = TRUE)) {
plot_composition_RCM(Year, CAA_plot, ages = age, dat_col = scenario$col)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) length composition from LL_Others."}
if(any(RCMdata@CAL[, , 4] > 0, na.rm = TRUE)) {
if(nsim == 1) CAL_plot <- array(x@CAL[, , , 4], c(1, nyears, RCMdata@Misc$nlbin)) else CAL_plot <- x@CAL[, , , 4]
plot_composition_RCM(Year, fit = CAL_plot, dat = RCMdata@CAL[, , 4], CAL_bins = length_bin, dat_col = scenario$col)
}
```


```{r, fig.cap = "Predicted length composition from LL_Others."}
if(any(RCMdata@CAL[, , 4] > 0, na.rm = TRUE)) {
plot_composition_RCM(Year, fit = CAL_plot, CAL_bins = RCMdata@Misc$lbinmid, dat_col = scenario$col)
}
```

###  HL_RR 

```{r, fig.cap = "Selectivity of HL_RR."}
bl <- unique(RCMdata@sel_block[, 5])
vul_bb <- list()
bl_col <- gplots::rich.colors(length(bl))
Year_legend <- character(length(bl))
for(bb in 1:length(bl)) {
  vul_bb[[bb]] <- sapply(report_list, function(x) x$vul_len[, bl[bb]])
  Year_legend[bb] <- Year[RCMdata@sel_block[, 5] == bl[bb]] %>% range() %>% paste(collapse = "-")
}
test <- vapply(vul_bb, function(x) all(!is.na(x)), logical(1))
if(all(test)) {
  matplot(RCMdata@Misc$lbinmid, RCMdata@Misc$lbinmid, type = "n", xlab = "Length", ylim = c(0, 1), ylab = "Selectivity of Fleet 5")
  abline(h = 0, col = "grey")
  for(bb in 1:length(bl)) {
    matlines(RCMdata@Misc$lbinmid, vul_bb[[bb]], type = "l", col = bl_col[bb], lty = scenario$lty, lwd = scenario$lwd)
  }
  if(length(bl) > 1) legend("topright", Year_legend, col = bl_col, lwd = 1)
}
```


```{r, fig.cap = "Corresponding age-based selectivity of HL_RR."}
matplot(age, age, type = "n", xlab = "Age", ylim = c(0, 1), ylab = "Selectivity of Fleet 5")
abline(h = 0, col = "grey")

for(bb in 1:length(bl)) {
  vul_bb_age <- do.call(rbind, lapply(report_list, function(x) x$vul[RCMdata@sel_block[, 5] == bl[bb], , 5])) %>% t()
  matlines(age, vul_bb_age, type = "l", col = bl_col[bb], lty = scenario$lty, lwd = scenario$lwd)
}
if(length(bl) > 1) legend("topleft", Year_legend, col = bl_col, lwd = 1)
```


```{r, fig.cap = "Fishing Mortality of HL_RR."}
FM <- sapply(report_list, function(x) x$F[, 5])
matplot(Year, FM, type = "l", col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, ylim = c(0, 1.1 * max(FM, na.rm = TRUE)), xlab = "Year", ylab = "Fishing Mortality of HL_RR")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) catch from HL_RR."}
if(any(RCMdata@Chist[, 5] > 0)) {
  Cpred <- sapply(report_list, function(x) x$Cpred[, 5])
  Chist <- RCMdata@Chist[, 5]
  ylim <- c(0.9, 1.1) * range(c(Cpred, Chist), na.rm = TRUE)
  plot(Year, Chist, type = "o", xlab = "Year", ylab = "Catch of HL_RR", ylim = ylim)
  matlines(Year, Cpred, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
} else {
  Cpred <- sapply(report_list, function(x) x$Cpred[, 5]/mean(x$Cpred[, 5]))
  matplot(Year, Cpred, col = scenario$col, type = "l", lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Predicted relative catch of HL_RR")
}
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) mean ages from HL_RR."}
MApred <- sapply(report_list, function(x) x$CAApred[, , 5] %*% age/x$CN[, 5])
MAobs <- (RCMdata@CAA[, , 5] %*% age)/rowSums(RCMdata@CAA[, , 5], na.rm = TRUE)
ylim <- c(0.9, 1.1) * range(c(MApred, MAobs), na.rm = TRUE)
matplot(Year, MApred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean age", ylim = ylim)
if(any(RCMdata@CAA[, , 5] > 0, na.rm = TRUE)) {
  lines(Year, MAobs, col = "black", typ = "o")
}
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) mean lengths from HL_RR."}
MLpred <- sapply(report_list, function(x) x$MLpred[, 5])
if(any(RCMdata@CAL[, , 5] > 0, na.rm = TRUE)) {
  MLobs <- (RCMdata@CAL[, , 5] %*% RCMdata@Misc$lbinmid)/rowSums(RCMdata@CAL[, , 5], na.rm = TRUE)
} else if(RCMdata@MS_type == "length" && any(RCMdata@MS[, 5] > 0, na.rm = TRUE)) MLobs <- RCMdata@MS[, 5] else MLobs <- NA
if(!all(is.na(MLpred))) {
  ylim <- c(0.9, 1.1) * range(c(MLpred, MLobs), na.rm = TRUE)
  matplot(Year, MLpred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean length", ylim = ylim)
  if(!all(is.na(MLobs))) lines(Year, MLobs, col = "black", typ = "o")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) mean weights from HL_RR."}
if(RCMdata@MS_type == "weight" && any(RCMdata@MS[, 5] > 0, na.rm = TRUE)) {
  MWobs <- RCMdata@MS[, 5]
} else MWobs <- NA
if(!all(is.na(MWobs))) {
  MWpred <- sapply(report_list, function(x) x$MWpred[, 5])
  ylim <- c(0.9, 1.1) * range(c(MWpred, MWobs), na.rm = TRUE)
  matplot(Year, MWpred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean weight", ylim = ylim)
  lines(Year, MWobs, col = "black", typ = "o")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) age composition from HL_RR."}
if(any(RCMdata@CAA[, , 5] > 0, na.rm = TRUE)) {
if(nsim == 1) CAA_plot <- array(x@CAA[, , , 5], c(1, nyears, max_age + 1)) else CAA_plot <- x@CAA[, , , 5]
plot_composition_RCM(Year, CAA_plot, RCMdata@CAA[, , 5], ages = age, dat_col = scenario$col)
}
```

```{r, fig.cap = "Predicted age composition from fleet 5."}
if(any(RCMdata@CAA[, , 5] > 0, na.rm = TRUE)) {
plot_composition_RCM(Year, CAA_plot, ages = age, dat_col = scenario$col)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) length composition from HL_RR."}
if(any(RCMdata@CAL[, , 5] > 0, na.rm = TRUE)) {
if(nsim == 1) CAL_plot <- array(x@CAL[, , , 5], c(1, nyears, RCMdata@Misc$nlbin)) else CAL_plot <- x@CAL[, , , 5]
plot_composition_RCM(Year, fit = CAL_plot, dat = RCMdata@CAL[, , 5], CAL_bins = length_bin, dat_col = scenario$col)
}
```


```{r, fig.cap = "Predicted length composition from HL_RR."}
if(any(RCMdata@CAL[, , 5] > 0, na.rm = TRUE)) {
plot_composition_RCM(Year, fit = CAL_plot, CAL_bins = RCMdata@Misc$lbinmid, dat_col = scenario$col)
}
```

### PS_West 


```{r, fig.cap = "Selectivity of PS_West in last historical year."}
if(!is.null(report_list[[1]]$ivul)) {
ivul_ff_age <- sapply(report_list, function(x) x$ivul[nyears, , 1])
matplot(age, ivul_ff_age, type = "l", col = scenario$col2, xlab = "Age", ylim = c(0, 1), ylab = "Selectivity of PS_West")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) index values for PS_West."}
Ipred <- sapply(report_list, function(x) x$Ipred[, 1])
matplot(Year, Ipred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, ylim = c(0, 1.1 * max(c(Ipred, RCMdata@Index[, 1]), na.rm = TRUE)), xlab = "Year", ylab = "PS_West")
lines(Year, RCMdata@Index[, 1], col = "black", typ = "o")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) index values for PS_West. Error bars indicate 95% confidence intervals for observed values."}
if(length(RCMdata@I_sd) && any(RCMdata@I_sd > 0, na.rm = TRUE)) {
  II <- RCMdata@Index[, 1]
  ind <- seq(min(which(!is.na(II))), max(which(!is.na(II))), 1)
  err <- exp(log(II) + outer(RCMdata@I_sd[, 1], c(-1.96, 1.96)))
  matplot(Year[ind], Ipred[ind, , drop = FALSE], type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, ylim = c(0, 1.1 * max(c(Ipred[ind, ], II[ind], err[ind, ]), na.rm = TRUE)), xlab = "Year", ylab = "PS_West")
  points(Year[ind], II[ind], lwd = 3, pch = 16)
  arrows(Year[ind], y0 = err[ind, 1], y1 = err[ind, 2], length = 0, lwd = 1.5)
  abline(h = 0, col = "grey")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) mean ages from PS_West."}
if(length(RCMdata@IAA) && any(RCMdata@IAA[, , 1] > 0, na.rm = TRUE)) {
MApred <- sapply(report_list, function(x) x$IAApred[, , 1] %*% age/rowSums(x$IAApred[, , 1]))
MAobs <- (RCMdata@IAA[, , 1] %*% age)/rowSums(RCMdata@IAA[, , 1], na.rm = TRUE)
ylim <- c(0.9, 1.1) * range(c(MApred, MAobs), na.rm = TRUE)
matplot(Year, MApred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean age", ylim = ylim)
if(any(RCMdata@IAA[, , 1] > 0, na.rm = TRUE)) {
  lines(Year, MAobs, col = "black", typ = "o")
}
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) mean lengths from PS_West."}
if(length(RCMdata@IAL) && any(RCMdata@IAL[, , 1] > 0, na.rm = TRUE)) {
MLpred <- sapply(report_list, function(x) x$IALpred[, , 1] %*% RCMdata@Misc$lbinmid/rowSums(x$IAApred[, , 1]))
MLobs <- (RCMdata@IAL[, , 1] %*% RCMdata@Misc$lbinmid)/rowSums(RCMdata@IAL[, , 1], na.rm = TRUE)
ylim <- c(0.9, 1.1) * range(c(MLpred, MLobs), na.rm = TRUE)
matplot(Year, MLpred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean length", ylim = ylim)
if(any(RCMdata@IAL[, , 1] > 0, na.rm = TRUE)) {
  lines(Year, MLobs, col = "black", typ = "o")
}
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) age composition from PS_West."}
if(length(RCMdata@IAA) && any(RCMdata@IAA[, , 1] > 0, na.rm = TRUE)) {
pred_IAA <- sapply(report_list, function(x) x$IAA[, , 1], simplify = "array") %>% aperm(perm = c(3, 1, 2))
plot_composition_RCM(Year, pred_IAA, RCMdata@IAA[, , 1], ages = age, dat_col = scenario$col)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) length composition from PS_West."}
if(length(RCMdata@IAL) && any(RCMdata@IAL[, , 1] > 0, na.rm = TRUE)) {
pred_IAL <- sapply(report_list, function(x) x$IAL[, , 1], simplify = "array") %>% aperm(perm = c(3, 1, 2))
plot_composition_RCM(Year, pred_IAL, RCMdata@IAL[, , 1], CAL_bins = length_bin, dat_col = scenario$col)
}
```

### BB_West 


```{r, fig.cap = "Selectivity of BB_West in last historical year."}
if(!is.null(report_list[[1]]$ivul)) {
ivul_ff_age <- sapply(report_list, function(x) x$ivul[nyears, , 2])
matplot(age, ivul_ff_age, type = "l", col = scenario$col2, xlab = "Age", ylim = c(0, 1), ylab = "Selectivity of BB_West")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) index values for BB_West."}
Ipred <- sapply(report_list, function(x) x$Ipred[, 2])
matplot(Year, Ipred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, ylim = c(0, 1.1 * max(c(Ipred, RCMdata@Index[, 2]), na.rm = TRUE)), xlab = "Year", ylab = "BB_West")
lines(Year, RCMdata@Index[, 2], col = "black", typ = "o")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) index values for BB_West. Error bars indicate 95% confidence intervals for observed values."}
if(length(RCMdata@I_sd) && any(RCMdata@I_sd > 0, na.rm = TRUE)) {
  II <- RCMdata@Index[, 2]
  ind <- seq(min(which(!is.na(II))), max(which(!is.na(II))), 1)
  err <- exp(log(II) + outer(RCMdata@I_sd[, 2], c(-1.96, 1.96)))
  matplot(Year[ind], Ipred[ind, , drop = FALSE], type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, ylim = c(0, 1.1 * max(c(Ipred[ind, ], II[ind], err[ind, ]), na.rm = TRUE)), xlab = "Year", ylab = "BB_West")
  points(Year[ind], II[ind], lwd = 3, pch = 16)
  arrows(Year[ind], y0 = err[ind, 1], y1 = err[ind, 2], length = 0, lwd = 1.5)
  abline(h = 0, col = "grey")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) mean ages from BB_West."}
if(length(RCMdata@IAA) && any(RCMdata@IAA[, , 2] > 0, na.rm = TRUE)) {
MApred <- sapply(report_list, function(x) x$IAApred[, , 2] %*% age/rowSums(x$IAApred[, , 2]))
MAobs <- (RCMdata@IAA[, , 2] %*% age)/rowSums(RCMdata@IAA[, , 2], na.rm = TRUE)
ylim <- c(0.9, 1.1) * range(c(MApred, MAobs), na.rm = TRUE)
matplot(Year, MApred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean age", ylim = ylim)
if(any(RCMdata@IAA[, , 2] > 0, na.rm = TRUE)) {
  lines(Year, MAobs, col = "black", typ = "o")
}
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) mean lengths from BB_West."}
if(length(RCMdata@IAL) && any(RCMdata@IAL[, , 2] > 0, na.rm = TRUE)) {
MLpred <- sapply(report_list, function(x) x$IALpred[, , 2] %*% RCMdata@Misc$lbinmid/rowSums(x$IAApred[, , 2]))
MLobs <- (RCMdata@IAL[, , 2] %*% RCMdata@Misc$lbinmid)/rowSums(RCMdata@IAL[, , 2], na.rm = TRUE)
ylim <- c(0.9, 1.1) * range(c(MLpred, MLobs), na.rm = TRUE)
matplot(Year, MLpred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean length", ylim = ylim)
if(any(RCMdata@IAL[, , 2] > 0, na.rm = TRUE)) {
  lines(Year, MLobs, col = "black", typ = "o")
}
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) age composition from BB_West."}
if(length(RCMdata@IAA) && any(RCMdata@IAA[, , 2] > 0, na.rm = TRUE)) {
pred_IAA <- sapply(report_list, function(x) x$IAA[, , 2], simplify = "array") %>% aperm(perm = c(3, 1, 2))
plot_composition_RCM(Year, pred_IAA, RCMdata@IAA[, , 2], ages = age, dat_col = scenario$col)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) length composition from BB_West."}
if(length(RCMdata@IAL) && any(RCMdata@IAL[, , 2] > 0, na.rm = TRUE)) {
pred_IAL <- sapply(report_list, function(x) x$IAL[, , 2], simplify = "array") %>% aperm(perm = c(3, 1, 2))
plot_composition_RCM(Year, pred_IAL, RCMdata@IAL[, , 2], CAL_bins = length_bin, dat_col = scenario$col)
}
```

### LL_USMX 


```{r, fig.cap = "Selectivity of LL_USMX in last historical year."}
if(!is.null(report_list[[1]]$ivul)) {
ivul_ff_age <- sapply(report_list, function(x) x$ivul[nyears, , 3])
matplot(age, ivul_ff_age, type = "l", col = scenario$col2, xlab = "Age", ylim = c(0, 1), ylab = "Selectivity of LL_USMX")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) index values for LL_USMX."}
Ipred <- sapply(report_list, function(x) x$Ipred[, 3])
matplot(Year, Ipred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, ylim = c(0, 1.1 * max(c(Ipred, RCMdata@Index[, 3]), na.rm = TRUE)), xlab = "Year", ylab = "LL_USMX")
lines(Year, RCMdata@Index[, 3], col = "black", typ = "o")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) index values for LL_USMX. Error bars indicate 95% confidence intervals for observed values."}
if(length(RCMdata@I_sd) && any(RCMdata@I_sd > 0, na.rm = TRUE)) {
  II <- RCMdata@Index[, 3]
  ind <- seq(min(which(!is.na(II))), max(which(!is.na(II))), 1)
  err <- exp(log(II) + outer(RCMdata@I_sd[, 3], c(-1.96, 1.96)))
  matplot(Year[ind], Ipred[ind, , drop = FALSE], type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, ylim = c(0, 1.1 * max(c(Ipred[ind, ], II[ind], err[ind, ]), na.rm = TRUE)), xlab = "Year", ylab = "LL_USMX")
  points(Year[ind], II[ind], lwd = 3, pch = 16)
  arrows(Year[ind], y0 = err[ind, 1], y1 = err[ind, 2], length = 0, lwd = 1.5)
  abline(h = 0, col = "grey")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) mean ages from LL_USMX."}
if(length(RCMdata@IAA) && any(RCMdata@IAA[, , 3] > 0, na.rm = TRUE)) {
MApred <- sapply(report_list, function(x) x$IAApred[, , 3] %*% age/rowSums(x$IAApred[, , 3]))
MAobs <- (RCMdata@IAA[, , 3] %*% age)/rowSums(RCMdata@IAA[, , 3], na.rm = TRUE)
ylim <- c(0.9, 1.1) * range(c(MApred, MAobs), na.rm = TRUE)
matplot(Year, MApred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean age", ylim = ylim)
if(any(RCMdata@IAA[, , 3] > 0, na.rm = TRUE)) {
  lines(Year, MAobs, col = "black", typ = "o")
}
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) mean lengths from LL_USMX."}
if(length(RCMdata@IAL) && any(RCMdata@IAL[, , 3] > 0, na.rm = TRUE)) {
MLpred <- sapply(report_list, function(x) x$IALpred[, , 3] %*% RCMdata@Misc$lbinmid/rowSums(x$IAApred[, , 3]))
MLobs <- (RCMdata@IAL[, , 3] %*% RCMdata@Misc$lbinmid)/rowSums(RCMdata@IAL[, , 3], na.rm = TRUE)
ylim <- c(0.9, 1.1) * range(c(MLpred, MLobs), na.rm = TRUE)
matplot(Year, MLpred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean length", ylim = ylim)
if(any(RCMdata@IAL[, , 3] > 0, na.rm = TRUE)) {
  lines(Year, MLobs, col = "black", typ = "o")
}
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) age composition from LL_USMX."}
if(length(RCMdata@IAA) && any(RCMdata@IAA[, , 3] > 0, na.rm = TRUE)) {
pred_IAA <- sapply(report_list, function(x) x$IAA[, , 3], simplify = "array") %>% aperm(perm = c(3, 1, 2))
plot_composition_RCM(Year, pred_IAA, RCMdata@IAA[, , 3], ages = age, dat_col = scenario$col)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) length composition from LL_USMX."}
if(length(RCMdata@IAL) && any(RCMdata@IAL[, , 3] > 0, na.rm = TRUE)) {
pred_IAL <- sapply(report_list, function(x) x$IAL[, , 3], simplify = "array") %>% aperm(perm = c(3, 1, 2))
plot_composition_RCM(Year, pred_IAL, RCMdata@IAL[, , 3], CAL_bins = length_bin, dat_col = scenario$col)
}
```

### HL_RR 


```{r, fig.cap = "Selectivity of HL_RR in last historical year."}
if(!is.null(report_list[[1]]$ivul)) {
ivul_ff_age <- sapply(report_list, function(x) x$ivul[nyears, , 4])
matplot(age, ivul_ff_age, type = "l", col = scenario$col2, xlab = "Age", ylim = c(0, 1), ylab = "Selectivity of HL_RR")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) index values for HL_RR."}
Ipred <- sapply(report_list, function(x) x$Ipred[, 4])
matplot(Year, Ipred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, ylim = c(0, 1.1 * max(c(Ipred, RCMdata@Index[, 4]), na.rm = TRUE)), xlab = "Year", ylab = "HL_RR")
lines(Year, RCMdata@Index[, 4], col = "black", typ = "o")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) index values for HL_RR. Error bars indicate 95% confidence intervals for observed values."}
if(length(RCMdata@I_sd) && any(RCMdata@I_sd > 0, na.rm = TRUE)) {
  II <- RCMdata@Index[, 4]
  ind <- seq(min(which(!is.na(II))), max(which(!is.na(II))), 1)
  err <- exp(log(II) + outer(RCMdata@I_sd[, 4], c(-1.96, 1.96)))
  matplot(Year[ind], Ipred[ind, , drop = FALSE], type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, ylim = c(0, 1.1 * max(c(Ipred[ind, ], II[ind], err[ind, ]), na.rm = TRUE)), xlab = "Year", ylab = "HL_RR")
  points(Year[ind], II[ind], lwd = 3, pch = 16)
  arrows(Year[ind], y0 = err[ind, 1], y1 = err[ind, 2], length = 0, lwd = 1.5)
  abline(h = 0, col = "grey")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) mean ages from HL_RR."}
if(length(RCMdata@IAA) && any(RCMdata@IAA[, , 4] > 0, na.rm = TRUE)) {
MApred <- sapply(report_list, function(x) x$IAApred[, , 4] %*% age/rowSums(x$IAApred[, , 4]))
MAobs <- (RCMdata@IAA[, , 4] %*% age)/rowSums(RCMdata@IAA[, , 4], na.rm = TRUE)
ylim <- c(0.9, 1.1) * range(c(MApred, MAobs), na.rm = TRUE)
matplot(Year, MApred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean age", ylim = ylim)
if(any(RCMdata@IAA[, , 4] > 0, na.rm = TRUE)) {
  lines(Year, MAobs, col = "black", typ = "o")
}
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) mean lengths from HL_RR."}
if(length(RCMdata@IAL) && any(RCMdata@IAL[, , 4] > 0, na.rm = TRUE)) {
MLpred <- sapply(report_list, function(x) x$IALpred[, , 4] %*% RCMdata@Misc$lbinmid/rowSums(x$IAApred[, , 4]))
MLobs <- (RCMdata@IAL[, , 4] %*% RCMdata@Misc$lbinmid)/rowSums(RCMdata@IAL[, , 4], na.rm = TRUE)
ylim <- c(0.9, 1.1) * range(c(MLpred, MLobs), na.rm = TRUE)
matplot(Year, MLpred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean length", ylim = ylim)
if(any(RCMdata@IAL[, , 4] > 0, na.rm = TRUE)) {
  lines(Year, MLobs, col = "black", typ = "o")
}
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) age composition from HL_RR."}
if(length(RCMdata@IAA) && any(RCMdata@IAA[, , 4] > 0, na.rm = TRUE)) {
pred_IAA <- sapply(report_list, function(x) x$IAA[, , 4], simplify = "array") %>% aperm(perm = c(3, 1, 2))
plot_composition_RCM(Year, pred_IAA, RCMdata@IAA[, , 4], ages = age, dat_col = scenario$col)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) length composition from HL_RR."}
if(length(RCMdata@IAL) && any(RCMdata@IAL[, , 4] > 0, na.rm = TRUE)) {
pred_IAL <- sapply(report_list, function(x) x$IAL[, , 4], simplify = "array") %>% aperm(perm = c(3, 1, 2))
plot_composition_RCM(Year, pred_IAL, RCMdata@IAL[, , 4], CAL_bins = length_bin, dat_col = scenario$col)
}
```

### BB_West_Hist 


```{r, fig.cap = "Selectivity of BB_West_Hist in last historical year."}
if(!is.null(report_list[[1]]$ivul)) {
ivul_ff_age <- sapply(report_list, function(x) x$ivul[nyears, , 5])
matplot(age, ivul_ff_age, type = "l", col = scenario$col2, xlab = "Age", ylim = c(0, 1), ylab = "Selectivity of BB_West_Hist")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) index values for BB_West_Hist."}
Ipred <- sapply(report_list, function(x) x$Ipred[, 5])
matplot(Year, Ipred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, ylim = c(0, 1.1 * max(c(Ipred, RCMdata@Index[, 5]), na.rm = TRUE)), xlab = "Year", ylab = "BB_West_Hist")
lines(Year, RCMdata@Index[, 5], col = "black", typ = "o")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Observed (black) and predicted (red) index values for BB_West_Hist. Error bars indicate 95% confidence intervals for observed values."}
if(length(RCMdata@I_sd) && any(RCMdata@I_sd > 0, na.rm = TRUE)) {
  II <- RCMdata@Index[, 5]
  ind <- seq(min(which(!is.na(II))), max(which(!is.na(II))), 1)
  err <- exp(log(II) + outer(RCMdata@I_sd[, 5], c(-1.96, 1.96)))
  matplot(Year[ind], Ipred[ind, , drop = FALSE], type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, ylim = c(0, 1.1 * max(c(Ipred[ind, ], II[ind], err[ind, ]), na.rm = TRUE)), xlab = "Year", ylab = "BB_West_Hist")
  points(Year[ind], II[ind], lwd = 3, pch = 16)
  arrows(Year[ind], y0 = err[ind, 1], y1 = err[ind, 2], length = 0, lwd = 1.5)
  abline(h = 0, col = "grey")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) mean ages from BB_West_Hist."}
if(length(RCMdata@IAA) && any(RCMdata@IAA[, , 5] > 0, na.rm = TRUE)) {
MApred <- sapply(report_list, function(x) x$IAApred[, , 5] %*% age/rowSums(x$IAApred[, , 5]))
MAobs <- (RCMdata@IAA[, , 5] %*% age)/rowSums(RCMdata@IAA[, , 5], na.rm = TRUE)
ylim <- c(0.9, 1.1) * range(c(MApred, MAobs), na.rm = TRUE)
matplot(Year, MApred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean age", ylim = ylim)
if(any(RCMdata@IAA[, , 5] > 0, na.rm = TRUE)) {
  lines(Year, MAobs, col = "black", typ = "o")
}
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) mean lengths from BB_West_Hist."}
if(length(RCMdata@IAL) && any(RCMdata@IAL[, , 5] > 0, na.rm = TRUE)) {
MLpred <- sapply(report_list, function(x) x$IALpred[, , 5] %*% RCMdata@Misc$lbinmid/rowSums(x$IAApred[, , 5]))
MLobs <- (RCMdata@IAL[, , 5] %*% RCMdata@Misc$lbinmid)/rowSums(RCMdata@IAL[, , 5], na.rm = TRUE)
ylim <- c(0.9, 1.1) * range(c(MLpred, MLobs), na.rm = TRUE)
matplot(Year, MLpred, type = "l", col = scenario$col, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Mean length", ylim = ylim)
if(any(RCMdata@IAL[, , 5] > 0, na.rm = TRUE)) {
  lines(Year, MLobs, col = "black", typ = "o")
}
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) age composition from BB_West_Hist."}
if(length(RCMdata@IAA) && any(RCMdata@IAA[, , 5] > 0, na.rm = TRUE)) {
pred_IAA <- sapply(report_list, function(x) x$IAA[, , 5], simplify = "array") %>% aperm(perm = c(3, 1, 2))
plot_composition_RCM(Year, pred_IAA, RCMdata@IAA[, , 5], ages = age, dat_col = scenario$col)
}
```


```{r, fig.cap = "Observed (black) and predicted (red) length composition from BB_West_Hist."}
if(length(RCMdata@IAL) && any(RCMdata@IAL[, , 5] > 0, na.rm = TRUE)) {
pred_IAL <- sapply(report_list, function(x) x$IAL[, , 5], simplify = "array") %>% aperm(perm = c(3, 1, 2))
plot_composition_RCM(Year, pred_IAL, RCMdata@IAL[, , 5], CAL_bins = length_bin, dat_col = scenario$col)
}
```

### Model predictions

```{r, fig.cap = "Histogram of initial depletion among all simulations."}
initD <- vapply(report_list, function(x) x$E[1]/x$E0_SR, numeric(1))
hist(initD, main = "", xlab = "Initial depletion")
```

```{r, fig.cap = "Estimated recruitment among all simulations."}
R_out <- sapply(report_list, getElement, "R")
matplot(Yearplusone, R_out, ylim = c(0, 1.1 * max(R_out, na.rm = TRUE)), type = "l", col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Recruitment")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```

```{r, fig.cap = "Estimated spawning biomass among all simulations."}
E <- sapply(report_list, getElement, "E")
matplot(Yearplusone, E, ylim = c(0, 1.1 * max(E, na.rm = TRUE)), type = "l", col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Spawning biomass")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Estimated spawning depletion among all simulations. Unfished spawning biomass is the value calculated from first year life history parameters."}
E_E0 <- sapply(report_list, function(x) x$E/x$E0_SR)
matplot(Yearplusone, E_E0, ylim = c(0, 1.1 * max(E_E0, na.rm = TRUE)), type = "l", col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "Spawning depletion")
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Dynamic SSB0 among all simulations. Model is re-run assuming no historical catches."}
dyn_SSB0 <- sapply(report_list, function(x) x$dynamic_SSB0)
matplot(Yearplusone, dyn_SSB0, ylim = c(0, 1.1 * max(dyn_SSB0, na.rm = TRUE)), type = "l", col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = expression(Dynamic~~SSB[0]))
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```

```{r, fig.cap = "Estimated recruitment deviations among all simulations."}
log_rec_dev2 <- sapply(report_list, getElement, "log_rec_dev")
matplot(Year, log_rec_dev2, type = "n", xlab = "Year", ylab = "log-recruitment deviations")
abline(h = 0, col = "grey")
matlines(Year, log_rec_dev2, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```

```{r, fig.cap = "Equilibrium spawning potential ratio (SPR) calculated from the biological parameters and F-at-age in the corresponding year for all simulations."}
SPR_eq <- sapply(report_list, getElement, "SPR_eq")
matplot(Year, SPR_eq, type = "n", ylim = c(0, 1), xlab = "Year", ylab = "Equilibrium SPR")
abline(h = 0, col = "grey")
matlines(Year, SPR_eq, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Dynamic spawning potential ratio (SPR) calculated from the biological parameters and cumulative survival of the cohorts in the corresponding year for all simulations."}
SPR_dyn <- sapply(report_list, getElement, "SPR_dyn")
matplot(Year, SPR_dyn, type = "n", ylim = c(0, 1), xlab = "Year", ylab = "Dynamic SPR")
abline(h = 0, col = "grey")
matlines(Year, SPR_dyn, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```

## Fit to mean parameters of the OM {.tabset}

### RCM Estimates

`r sdreport_int(SD) %>% signif(4) %>% format() %>% as.data.frame()`


### Life History

```{r, fig.cap = "Length-at-age in last historical year."}
ymax <- 1.1 * max(data_mean_fit$len_age[nyears, ])
plot_generic_at_age(age, data_mean_fit$len_age[nyears, ], label = "Length-at-age", ymax = 1.1 * ymax)
```

```{r, fig.cap="Maturity-at-age in last historical year."}
plot_generic_at_age(age, data_mean_fit$mat[nyears, ], label = "Maturity")
```

```{r, fig.cap="Natural mortality in last historical year."}
plot_generic_at_age(age, data_mean_fit$M[nyears, ], label = "Natural mortality")
```

### Data and Fit {.tabset}
#### Catch 

```{r, fig.cap = "Catch time series."}
yy <- RCMdata@Chist
matplot(Year, RCMdata@Chist, type = "l", lty = 1, col = rich.colors(nfleet), ylim = c(0, 1.1 * max(yy, na.rm = TRUE)), xlab = "Year", ylab = "Catch")
abline(h = 0, col = "grey")
if(ncol(yy) > 1) legend("topleft", f_name, text.col = rich.colors(nfleet))
```

```{r, fig.cap = "Observed (black) and predicted (red) catch from fleet 1. Predicted catch from fleet 1 should match observed in this model."}
plot_timeseries(Year, RCMdata@Chist[, 1], report$Cpred[, 1], label = "PS_West")
```

```{r, fig.cap = "Observed (black) and predicted (red) catch from fleet 2. Predicted catch from fleet 2 should match observed in this model."}
plot_timeseries(Year, RCMdata@Chist[, 2], report$Cpred[, 2], label = "BB_West")
```

```{r, fig.cap = "Observed (black) and predicted (red) catch from fleet 3. Predicted catch from fleet 3 should match observed in this model."}
plot_timeseries(Year, RCMdata@Chist[, 3], report$Cpred[, 3], label = "LL_USMX")
```

```{r, fig.cap = "Observed (black) and predicted (red) catch from fleet 4. Predicted catch from fleet 4 should match observed in this model."}
plot_timeseries(Year, RCMdata@Chist[, 4], report$Cpred[, 4], label = "LL_Others")
```

```{r, fig.cap = "Observed (black) and predicted (red) catch from fleet 5. Predicted catch from fleet 5 should match observed in this model."}
plot_timeseries(Year, RCMdata@Chist[, 5], report$Cpred[, 5], label = "HL_RR")
```

#### Index 

```{r, fig.cap = "Observed (black) and predicted (red) index from survey 1."}
plot_timeseries(Year, RCMdata@Index[, 1], report$Ipred[, 1], label = "PS_West")
```

```{r, fig.cap = "Observed (black) and predicted (red) index from survey 2."}
plot_timeseries(Year, RCMdata@Index[, 2], report$Ipred[, 2], label = "BB_West")
```

```{r, fig.cap = "Observed (black) and predicted (red) index from survey 3."}
plot_timeseries(Year, RCMdata@Index[, 3], report$Ipred[, 3], label = "LL_USMX")
```

```{r, fig.cap = "Observed (black) and predicted (red) index from survey 4."}
plot_timeseries(Year, RCMdata@Index[, 4], report$Ipred[, 4], label = "HL_RR")
```

```{r, fig.cap = "Observed (black) and predicted (red) index from survey 5."}
plot_timeseries(Year, RCMdata@Index[, 5], report$Ipred[, 5], label = "BB_West_Hist")
```

```{r, fig.cap = "Index residuals (in log space) for index from survey 1."}
istart <- which(!is.na(RCMdata@Index[, 1]))[1]
istop <- which(!is.na(RCMdata@Index[, 1])) %>% max()
plot_residuals(Year[istart:istop], log(RCMdata@Index[, 1][istart:istop]/report$Ipred[, 1][istart:istop]), label = "PS_West Residuals")
```

```{r, fig.cap = "Index residuals (in log space) for index from survey 2."}
istart <- which(!is.na(RCMdata@Index[, 2]))[1]
istop <- which(!is.na(RCMdata@Index[, 2])) %>% max()
plot_residuals(Year[istart:istop], log(RCMdata@Index[, 2][istart:istop]/report$Ipred[, 2][istart:istop]), label = "BB_West Residuals")
```

```{r, fig.cap = "Index residuals (in log space) for index from survey 3."}
istart <- which(!is.na(RCMdata@Index[, 3]))[1]
istop <- which(!is.na(RCMdata@Index[, 3])) %>% max()
plot_residuals(Year[istart:istop], log(RCMdata@Index[, 3][istart:istop]/report$Ipred[, 3][istart:istop]), label = "LL_USMX Residuals")
```

```{r, fig.cap = "Index residuals (in log space) for index from survey 4."}
istart <- which(!is.na(RCMdata@Index[, 4]))[1]
istop <- which(!is.na(RCMdata@Index[, 4])) %>% max()
plot_residuals(Year[istart:istop], log(RCMdata@Index[, 4][istart:istop]/report$Ipred[, 4][istart:istop]), label = "HL_RR Residuals")
```

```{r, fig.cap = "Index residuals (in log space) for index from survey 5."}
istart <- which(!is.na(RCMdata@Index[, 5]))[1]
istop <- which(!is.na(RCMdata@Index[, 5])) %>% max()
plot_residuals(Year[istart:istop], log(RCMdata@Index[, 5][istart:istop]/report$Ipred[, 5][istart:istop]), label = "BB_West_Hist Residuals")
```

#### Length comps 

```{r, fig.cap = "Observed (black) and predicted (red) length composition from PS_West."}
ind_valid <- rowSums(RCMdata@CAL[, , 1], na.rm = TRUE) > 0
if(any(ind_valid)) plot_composition(Year[ind_valid], RCMdata@CAL[, , 1][ind_valid, , drop = FALSE], report$CALpred[, , 1][ind_valid, , drop = FALSE], plot_type = "annual", CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, bubble_adj = 10)
```

```{r, fig.cap = "Residuals for length composition from PS_West."}
ind_valid <- rowSums(RCMdata@CAL[, , 1], na.rm = TRUE) > 0
if(any(ind_valid)) plot_composition(Year[ind_valid], RCMdata@CAL[, , 1][ind_valid, , drop = FALSE], report$CALpred[, , 1][ind_valid, , drop = FALSE], plot_type = "bubble_residuals", CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, bubble_adj = 10)
```

```{r, fig.cap = "Observed (black) and predicted (red) mean length from the composition data for PS_West."}
ind_valid <- rowSums(RCMdata@CAL[, , 1], na.rm = TRUE) > 0
if(any(ind_valid)) plot_composition(Year[ind_valid], RCMdata@CAL[, , 1][ind_valid, , drop = FALSE], report$CALpred[, , 1][ind_valid, , drop = FALSE], plot_type = "mean", CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, bubble_adj = 10)
```

```{r, fig.cap = "Observed (black) and predicted (red) length composition from BB_West."}
ind_valid <- rowSums(RCMdata@CAL[, , 2], na.rm = TRUE) > 0
if(any(ind_valid)) plot_composition(Year[ind_valid], RCMdata@CAL[, , 2][ind_valid, , drop = FALSE], report$CALpred[, , 2][ind_valid, , drop = FALSE], plot_type = "annual", CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, bubble_adj = 10)
```

```{r, fig.cap = "Residuals for length composition from BB_West."}
ind_valid <- rowSums(RCMdata@CAL[, , 2], na.rm = TRUE) > 0
if(any(ind_valid)) plot_composition(Year[ind_valid], RCMdata@CAL[, , 2][ind_valid, , drop = FALSE], report$CALpred[, , 2][ind_valid, , drop = FALSE], plot_type = "bubble_residuals", CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, bubble_adj = 10)
```

```{r, fig.cap = "Observed (black) and predicted (red) mean length from the composition data for BB_West."}
ind_valid <- rowSums(RCMdata@CAL[, , 2], na.rm = TRUE) > 0
if(any(ind_valid)) plot_composition(Year[ind_valid], RCMdata@CAL[, , 2][ind_valid, , drop = FALSE], report$CALpred[, , 2][ind_valid, , drop = FALSE], plot_type = "mean", CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, bubble_adj = 10)
```

```{r, fig.cap = "Observed (black) and predicted (red) length composition from LL_USMX."}
ind_valid <- rowSums(RCMdata@CAL[, , 3], na.rm = TRUE) > 0
if(any(ind_valid)) plot_composition(Year[ind_valid], RCMdata@CAL[, , 3][ind_valid, , drop = FALSE], report$CALpred[, , 3][ind_valid, , drop = FALSE], plot_type = "annual", CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, bubble_adj = 10)
```

```{r, fig.cap = "Residuals for length composition from LL_USMX."}
ind_valid <- rowSums(RCMdata@CAL[, , 3], na.rm = TRUE) > 0
if(any(ind_valid)) plot_composition(Year[ind_valid], RCMdata@CAL[, , 3][ind_valid, , drop = FALSE], report$CALpred[, , 3][ind_valid, , drop = FALSE], plot_type = "bubble_residuals", CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, bubble_adj = 10)
```

```{r, fig.cap = "Observed (black) and predicted (red) mean length from the composition data for LL_USMX."}
ind_valid <- rowSums(RCMdata@CAL[, , 3], na.rm = TRUE) > 0
if(any(ind_valid)) plot_composition(Year[ind_valid], RCMdata@CAL[, , 3][ind_valid, , drop = FALSE], report$CALpred[, , 3][ind_valid, , drop = FALSE], plot_type = "mean", CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, bubble_adj = 10)
```

```{r, fig.cap = "Observed (black) and predicted (red) length composition from LL_Others."}
ind_valid <- rowSums(RCMdata@CAL[, , 4], na.rm = TRUE) > 0
if(any(ind_valid)) plot_composition(Year[ind_valid], RCMdata@CAL[, , 4][ind_valid, , drop = FALSE], report$CALpred[, , 4][ind_valid, , drop = FALSE], plot_type = "annual", CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, bubble_adj = 10)
```

```{r, fig.cap = "Residuals for length composition from LL_Others."}
ind_valid <- rowSums(RCMdata@CAL[, , 4], na.rm = TRUE) > 0
if(any(ind_valid)) plot_composition(Year[ind_valid], RCMdata@CAL[, , 4][ind_valid, , drop = FALSE], report$CALpred[, , 4][ind_valid, , drop = FALSE], plot_type = "bubble_residuals", CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, bubble_adj = 10)
```

```{r, fig.cap = "Observed (black) and predicted (red) mean length from the composition data for LL_Others."}
ind_valid <- rowSums(RCMdata@CAL[, , 4], na.rm = TRUE) > 0
if(any(ind_valid)) plot_composition(Year[ind_valid], RCMdata@CAL[, , 4][ind_valid, , drop = FALSE], report$CALpred[, , 4][ind_valid, , drop = FALSE], plot_type = "mean", CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, bubble_adj = 10)
```

```{r, fig.cap = "Observed (black) and predicted (red) length composition from HL_RR."}
ind_valid <- rowSums(RCMdata@CAL[, , 5], na.rm = TRUE) > 0
if(any(ind_valid)) plot_composition(Year[ind_valid], RCMdata@CAL[, , 5][ind_valid, , drop = FALSE], report$CALpred[, , 5][ind_valid, , drop = FALSE], plot_type = "annual", CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, bubble_adj = 10)
```

```{r, fig.cap = "Residuals for length composition from HL_RR."}
ind_valid <- rowSums(RCMdata@CAL[, , 5], na.rm = TRUE) > 0
if(any(ind_valid)) plot_composition(Year[ind_valid], RCMdata@CAL[, , 5][ind_valid, , drop = FALSE], report$CALpred[, , 5][ind_valid, , drop = FALSE], plot_type = "bubble_residuals", CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, bubble_adj = 10)
```

```{r, fig.cap = "Observed (black) and predicted (red) mean length from the composition data for HL_RR."}
ind_valid <- rowSums(RCMdata@CAL[, , 5], na.rm = TRUE) > 0
if(any(ind_valid)) plot_composition(Year[ind_valid], RCMdata@CAL[, , 5][ind_valid, , drop = FALSE], report$CALpred[, , 5][ind_valid, , drop = FALSE], plot_type = "mean", CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, bubble_adj = 10)
```

### Output 

```{r, fig.cap = "Terminal year selectivity by fleet."}
yy <- matrix(report$vul[nyears, , ], max_age + 1, nfleet)
matplot(age, matrix(report$vul[nyears, , ], max_age + 1, nfleet), type = "l", lty = 1, col = rich.colors(nfleet), ylim = c(0, 1.1 * max(yy, na.rm = TRUE)), xlab = "Age", ylab = "Selectivity")
abline(h = 0, col = "grey")
if(ncol(yy) > 1) legend("topleft", f_name, text.col = rich.colors(nfleet))
```

```{r, fig.cap = "Time series of fishing mortality by fleet."}
yy <- report$F
matplot(Year, report$F, type = "l", lty = 1, col = rich.colors(nfleet), ylim = c(0, 1.1 * max(yy, na.rm = TRUE)), xlab = "Year", ylab = "Fishing Mortality (F)")
abline(h = 0, col = "grey")
if(ncol(yy) > 1) legend("topleft", f_name, text.col = rich.colors(nfleet))
```

```{r, fig.cap="Time series of spawning biomass."}
plot_timeseries(as.numeric(names(structure(report$E, names = Yearplusone))),structure(report$E, names = Yearplusone), label = "Spawning biomass")


```

```{r, fig.cap="Time series of spawning depletion."}
plot_timeseries(as.numeric(names(structure(report$E/report$E0_SR, names = Yearplusone))),structure(report$E/report$E0_SR, names = Yearplusone), label = expression(SSB/SSB[0]))


```

```{r, fig.cap="Time series of dynamic SSB0."}
plot_timeseries(as.numeric(names(structure(report$dynamic_SSB0, names = Yearplusone))),structure(report$dynamic_SSB0, names = Yearplusone), label = expression("Dynamic"~SSB[0]))


```

```{r, fig.cap="Time series of recruitment."}
plot_timeseries(as.numeric(names(structure(report$R, names = Yearplusone))),structure(report$R, names = Yearplusone), label = "Recruitment (R)")


```

```{r, fig.cap = "Stock-recruit relationship and estimated recruitment."}
if(OM@SRrel == 1) {
  expectedR <- report$Arec * report$E / (1 + report$Brec * report$E)
} else {
  expectedR <- report$Arec * report$E * exp(-report$Brec * report$E)
}
plot_SR(report$E, expectedR, report$R0, report$E0_SR, report$R)
```

```{r, fig.cap = "Annual spawning potential ratio (SPR). Equilibrium SPR is calculated from the F-at-age in the corresponding year, while dynamic SPR is calculated from the cumulative survival of cohorts."}
plot(Year, report$SPR_eq, typ = "o", lty = 3, ylim = c(0, 1), xlab = "Year", ylab = "Spawning potential ratio")
lines(Year, report$SPR_dyn, typ = "o", pch = 16)
legend("bottomleft", c("Equilibrium SPR", "Dynamic SPR"), lty = c(3, 1), pch = c(1, 16))
abline(h = 0, col = "grey")
```

```{r, fig.cap="Time series of recruitment deviations."}
plot_residuals(as.numeric(names(structure(report$log_rec_dev, names = Year))), structure(report$log_rec_dev, names = Year) , res_sd = NULL, label = "log-Recruitment deviations")
```

```{r, fig.cap="Time series of recruitment deviations with 95% confidence intervals."}
if(conv) plot_residuals(as.numeric(names(structure(report$log_rec_dev, names = Year))), structure(report$log_rec_dev, names = Year) , res_sd = ifelse(data_mean_fit$est_rec_dev == 1, as.list(SD, "Std. Error")$log_rec_dev, 0), label = "log-Recruitment deviations")
```

```{r, fig.cap="Time series of abundance."}
plot_timeseries(as.numeric(names(structure(rowSums(report$N), names = Yearplusone))),structure(rowSums(report$N), names = Yearplusone), label = "Abundance (N)")


```

```{r, fig.cap="Predicted abundance-at-age."}
plot_composition(Yearplusone, report$N, CAL_bins = NULL, ages = age, plot_type = "bubble_data", bubble_adj = 5)
```

```{r, fig.cap="Predicted catch-at-age (summed over all fleets)."}
plot_composition(Year, apply(report$CAApred, 1:2, sum), CAL_bins = NULL, ages = age, plot_type = "bubble_data", bubble_adj = 10)
```

```{r, fig.cap="Predicted catch-at-length (summed over all fleets)."}
plot_composition(Year, apply(report$CALpred, 1:2, sum), CAL_bins = RCMdata@Misc$lbinmid, ages = NULL, plot_type = "bubble_data", bubble_adj = 10)
```

### Likelihood components

#### Summary

`r nll[[1]] 

`


#### Fleet likelihoods

`r nll[[2]] 

`


#### Fleet weights

`r nll[[3]] 

`


#### Survey likelihoods

`r nll[[4]] 

`


#### Survey weights

`r nll[[5]] 

`


### Correlation matrix

`r SD$env$corr.fixed %>% structure(dimnames = list(make_unique_names(rownames(.)), make_unique_names(colnames(.)))) %>% as.data.frame()`


## Updated OM {.tabset}

### OM historical period


```{r, fig.cap = "Apical F from the operating model."}
Hist_F <- apply(Hist@AtAge$F.Mortality, c(1, 3), max, na.rm = TRUE)
matplot(Year, t(Hist_F), typ = "l", col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "OM Apical F", ylim = c(0, 1.1 * max(Hist_F)))
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Spawning biomass (SSB) from the operating model."}
Hist_SSB <- apply(Hist@TSdata$SBiomass, 1:2, sum)
matplot(Year, t(Hist_SSB), typ = "l", col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "OM SSB", ylim = c(0, 1.1 * max(Hist_SSB)))
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Spawning biomass (SSB) relative to MSY from the operating model."}
matplot(Year, t(Hist_SSB/Hist@Ref$ReferencePoints$SSBMSY), col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, typ = "l", xlab = "Year", ylab = expression(OM~~SSB/SSB[MSY]), ylim = c(0, 1.1 * max(Hist_SSB/Hist@Ref$ReferencePoints$SSBMSY)))
abline(h = c(0, MSY_ref), col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Spawning biomass (SSB) relative to MSY in the most recent decade."}
if(length(Year) > 10) {
  Yr_ind <- Year > max(Year) - 10
  matplot(Year[Yr_ind], t(Hist_SSB[, Yr_ind, drop = FALSE]/Hist@Ref$ReferencePoints$SSBMSY), typ = "l", col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = expression(OM~~SSB/SSB[MSY]), ylim = c(0, 1.1 * max(Hist_SSB[, Yr_ind, drop = FALSE]/Hist@Ref$ReferencePoints$SSBMSY)))
  abline(h = c(0, MSY_ref), col = "grey")
  if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
}
```


```{r, fig.cap = "Spawning depletion from the operating model."}
matplot(Year, t(Hist_SSB/Hist@Ref$ReferencePoints$SSB0), typ = "l", col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = expression(OM~~SSB/SSB[0]), ylim = c(0, 1.1 * max(Hist_SSB/Hist@Ref$ReferencePoints$SSB0)))
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Recruitment (age-0) from the operating model."}
Hist_R <- Hist@AtAge$Number[, 1, , ] %>% apply(c(1, 2), sum)
matplot(Year, t(Hist_R), typ = "l", col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "OM Recruitment", ylim = c(0, 1.1 * max(Hist_R)))
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```


```{r, fig.cap = "Catch (total removals, including discards) from the operating model."}
Hist_C <- apply(Hist@TSdata$Removals, 1:2, sum)
matplot(Year, t(Hist_C), typ = "l", col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd, xlab = "Year", ylab = "OM Catch", ylim = c(0, 1.1 * max(Hist_C)))
abline(h = 0, col = "grey")
if(!is.null(scenario$names)) legend("topleft", scenario$names, col = scenario$col2, lty = scenario$lty, lwd = scenario$lwd)
```


### OM/RCM Comparison


```{r, fig.cap = "Apical F comparison between the OM and RCM."}
matplot(Year, t(Hist_F), typ = "o", pch = 16, col = "red", xlab = "Year", ylab = "Apical F", ylim = c(0, 1.1 * max(c(Hist_F, OM@cpars$Find))))
matlines(Year, t(OM@cpars$Find), col = "black")
abline(h = 0, col = "grey")
legend("topleft", c("RCM", "OM"), col = c("black", "red"), pch = c(NA_integer_, 16), lwd = c(1, 1), bty = "n")
```


```{r, fig.cap = "Difference in apical F between the OM and RCM. Positive values indicate higher F in the OM."}
matplot(Year, t(Hist_F - OM@cpars$Find), typ = "n", xlab = "Year", ylab = "Difference in apical F")
abline(h = 0, col = "grey")
matlines(Year, t(Hist_F - OM@cpars$Find), col = "black")
```


```{r, fig.cap = "SSB comparison between the OM and RCM."}
matplot(Year, t(Hist_SSB), typ = "o", col = "red", pch = 16, xlab = "Year", ylab = "SSB",
        ylim = c(0, 1.1 * max(c(Hist_SSB, x@SSB[sims, 1:OM@nyears]))))
matlines(Year, t(x@SSB[sims, 1:OM@nyears, drop = FALSE]), col = "black")
abline(h = 0, col = "grey")
legend("topleft", c("RCM", "OM"), col = c("black", "red"), pch = c(NA_integer_, 16), lwd = c(1, 1), bty = "n")
```


```{r, fig.cap = "Difference in spawning biomass (SSB), relative to SSB0, between the OM and RCM, calculated as $(SSB^{OM}_y - SSB^{RCM}_y)/SSB^{OM}_0$. Positive values indicate higher SSB in the OM."}
matplot(Year, t((Hist_SSB - x@SSB[sims, 1:OM@nyears, drop = FALSE])/Hist@Ref$ReferencePoints$SSB0), typ = "n", xlab = "Year", ylab = "Difference in relative SSB")
abline(h = 0, col = "grey")
matlines(Year, t((Hist_SSB - x@SSB[sims, 1:OM@nyears, drop = FALSE])/Hist@Ref$ReferencePoints$SSB0), col = "black")
```


```{r, fig.cap = "Recruitment comparison between the OM and RCM."}
matplot(Year, t(Hist_R), typ = "o", col = "red", pch = 16, xlab = "Year", ylab = "Recruitment",
        ylim = c(0, 1.1 * max(c(Hist_R, x@NAA[sims, 1:OM@nyears, 1]))))
matlines(Year, t(x@NAA[, 1:OM@nyears, 1][sims, , drop = FALSE]), col = "black")
abline(h = 0, col = "grey")
legend("topleft", c("RCM", "OM"), col = c("black", "red"), pch = c(NA_integer_, 16), lwd = c(1, 1), bty = "n")
```


```{r, fig.cap = "Difference in recruitment (relative to R0) between the OM and RCM, calculated as $(R^{OM}_y - R^{RCM}_y)/R^{OM}_0$. Positive values indicate higher recruitment in the OM."}
matplot(Year, t(Hist_R/OM@cpars$R0 - x@NAA[, 1:OM@nyears, 1][sims, , drop = FALSE]/OM@cpars$R0), typ = "n", xlab = "Year", ylab = "Difference in relative recruitment")
abline(h = 0, col = "grey")
matlines(Year, t(Hist_R/OM@cpars$R0 - x@NAA[, 1:OM@nyears, 1][sims, , drop = FALSE]/OM@cpars$R0),
         col = "black")
```


```{r, fig.cap = "Comparison of total removals between the OM and RCM."}
RCM_C <- sapply(x@Misc, function(xx) rowSums(xx$Cpred)) %>% t()
matplot(Year, t(Hist_C), typ = "o", col = "red", pch = 16, xlab = "Year", ylab = "Total removals",
        ylim = c(0, 1.1 * max(Hist_C, RCMdata@Chist)))
matlines(Year, t(RCM_C[sims, , drop = FALSE]), col = "black")
abline(h = 0, col = "grey")
legend("topleft", c("RCM", "OM"), col = c("black", "red"), pch = c(NA_integer_, 16), lwd = c(1, 1), bty = "n")
```


```{r, fig.cap = "Difference in removals (relative to RCM predicted), calculated as $C^{OM}_y/C^{RCM}_y - 1$. Positive values indicate higher removals in the OM."}
Catch_difference <- t(Hist_C/RCM_C[sims, , drop = FALSE]) - 1
Catch_difference[is.infinite(Catch_difference)] <- 0
matplot(Year, Catch_difference, typ = "n", xlab = "Year", ylab = "Difference in relative removals")
abline(h = 0, col = "grey")
matlines(Year, Catch_difference, col = "black")
```

## About

This report was generated on: `r Sys.time()`<br />
SAMtool R package version `r packageVersion("SAMtool")`<br />
`r R.version.string`<br />

